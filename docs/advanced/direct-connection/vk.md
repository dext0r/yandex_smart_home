---
title: Прямое подключение (Маруся)
---
# Прямое подключение (Маруся)

!!! danger "Только для продвинутых пользователей!"

!!! warning "На прямом типе подключения не будут работать сценарии по состоянию устройств и датчиков"

!!! warning "Диагностика проблем при прямом подключении крайне затруднена, приложение Маруся не выкидывает ошибки при недоступности Home Assistant, а просто не отображает устройства"

Для использования прямого подключения вы самостоятельно создаёте приложение на платформе VK для разработчиков, которое будет напрямую подключаться к вашему Home Assistant (не используя навык Yaha Cloud).

## Предварительные требования { id=requirements }

* Доступность Home Assistant из интернета по **доменному имени** используя белый IP адрес или
  сторонние сервисы: [Dataplicity](https://github.com/AlexxIT/Dataplicity), [KeenDNS](https://keenetic.link). По этому же доменному имени Home Assistant должен быть доступен и из локальной сети.
* Настроенный HTTPS сертификат. При наличии белого IP адреса можно воспользоваться официальным аддоном Let's Encrypt.
  При использовании Dataplicity или KeenDNS HTTPS настраивается автоматически. Самоподписанные сертификаты работать не будут.
* Прописанный адрес Home Assistant в разделе `Настройки` --> `Система` --> `Сеть` --> `URL-адрес сервера` --> `Интернет` (для видимости раздела включите `Расширенный режим` в профиле пользователя) или в параметре [`external_url`](https://www.home-assistant.io/integrations/homeassistant/#external_url) в `configuration.yaml`.
* Перед добавлением интеграции обязательно [проверьте доступность HA из интернета](#no-connection).

## Настройка { id=config }

* Установите [компонент](../../install/component.md) и добавьте [интеграцию](../../install/integration.md) используя прямой тип подключения
* Зайдите на [platform.vk.com](https://platform.vk.com) и зарегистрируйтесь как физическое лицо
* Создайте проект с любым названием
* Перейдите в созданный проект > Добавить приложение:
    * Название: **Home Assistant** (или другое)
    * Тип: Умный дом с Марусей
* Перейдите в созданное приложение и заполните параметры:

| Поле                        | Значение                                                                                                                         |
| --------------------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| Название                    | Любое (например `Home Assistant`)                                                                                                |
| Адрес API                   | `https://[YOUR_HA_DOMAIN:PORT]/api/yandex_smart_home/v1.0`<br>(пример: `https://XXXX.dataplicity.io/api/yandex_smart_home/v1.0`) |
| Адрес страницы авторизации  | `https://[YOUR_HA_DOMAIN:PORT]/auth/authorize`                                                                                   |
| Адрес для получения тоĸена  | `https://[YOUR_HA_DOMAIN:PORT]/auth/token`                                                                                       |
| Адрес для обновления токена | `https://[YOUR_HA_DOMAIN:PORT]/auth/token`                                                                                       |
| Авторизационный client_id   | `https://vc.go.mail.ru`                                                                                                          |
| Авторизационный secret      | Любой, например: `secret`                                                                                                        |
| Протокол интеграции         | Яндекс                                                                                                                           |

!!! info "Все параметры приложения также продублированы в настройках интеграции в разделе Параметры приложения"

* Откройте приложение [Маруся](https://trk.mail.ru/c/u2dc49) ([веб-версия](https://m.vk.com/app8022694))
* Нажмите иконку :fontawesome-solid-house: в правом верхнем углу
* Нажмите кнопку :fontawesome-solid-plus: в правом верхнем углу --> `Подключить устройство`
* Найдите в списке и выберите приложение, которое вы создали
* Откроется страница авторизации Home Assistant
* Выполните привязку используя имя пользователя, указанное при настройке интеграции

## Проблемы { id=issues }

### Маруся не может достучаться до Home Assistant { id=no-connection }

!!! warning "При недоступности Home Assistant в приложении Маруся не будет никаких ошибок!"

1. Проверьте доступность Home Assistant из интернета через сервис [httpstatus.io](https://httpstatus.io):
     * Вставьте ссылку `https://YOUR_HA_DOMAIN:PORT/manifest.json` и нажмите `Check status`.<br>
       Альтернативная ссылка для проверки `https://YOUR_HA_DOMAIN:PORT/api/yandex_smart_home/v1.0/ping` – будет доступна только если добавлена хотя бы одна интеграция Yandex Smart Home, в остальных случаях по ней возвращается `404`.
     * Убедитесь, что возвращается код `200` (столбец `Status codes`)

2. Если сертификат настраивался вручную: убедитесь, что используется fullchain сертификат
   (в случае штатного аддона Let's Encrypt он в файле fullchain.cer):

  ```yaml
  http:
    ssl_certificate: /config/acme.sh/YOUR_HA_DOMAIN/fullchain.cer
    ssl_key: /config/acme.sh/YOUR_HA_DOMAIN/YOUR_HA_DOMAIN.key
  ```

  Корректность установки сертификата можно проверить через [этот](https://www.sslshopper.com/ssl-checker.html) сервис.
3. Если DNS запись добавлялась вручную: убедитесь, что у используемого домена нет AAAA записи (должна быть только A).
